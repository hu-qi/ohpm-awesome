name: ğŸ”„ Update OpenHarmony Packages

on:
  schedule:
    # Run daily at 00:00 UTC (8:00 AM Beijing time)
    - cron: '0 0 * * *'
  workflow_dispatch:
    # Allow manual triggering
  push:
    branches: [ main ]
    paths: 
      - 'crawler.py'
      - 'analyzer.py'

jobs:
  update-packages:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write

    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: ğŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: ğŸ•·ï¸ Crawl OpenHarmony Packages
      run: |
        echo "ğŸš€ Starting package crawling..."
        python crawler.py
        echo "âœ… Package crawling completed"

        if [ ! -f "packages.json" ]; then
          echo "âŒ Error: packages.json not found"
          exit 1
        fi

        PACKAGE_COUNT=$(python -c "import json; data=json.load(open('packages.json')); print(len(data['packages']))")
        echo "ğŸ“Š Found $PACKAGE_COUNT packages"

        if [ "$PACKAGE_COUNT" -lt 1000 ]; then
          echo "âš ï¸  Warning: Package count seems low ($PACKAGE_COUNT), continuing anyway..."
        fi

    - name: ğŸ” Analyze and Categorize Packages
      run: |
        echo "ğŸ§  Starting package analysis and categorization..."
        python analyzer.py
        echo "âœ… Package analysis completed"

        if [ ! -f "README.md" ]; then
          echo "âŒ Error: README.md not generated"
          exit 1
        fi

        echo "ğŸ“„ README.md generated successfully"

    - name: ğŸ“Š Generate Update Summary
      id: summary
      run: |
        # Get package statistics
        TOTAL_PACKAGES=$(python -c "import json; data=json.load(open('packages.json')); print(len(data['packages']))")
        CRAWL_TIME=$(python -c "import json; data=json.load(open('packages.json')); print(data['crawled_at'])")
        RECENT_PACKAGE=$(python -c "import json; data=json.load(open('packages.json')); packages=sorted(data['packages'], key=lambda p: p.get('latestPublishTime', 0), reverse=True); print(packages[0]['name'] + ' v' + packages[0].get('latestVersion', 'N/A')) if packages else print('N/A')")

        echo "TOTAL_PACKAGES=$TOTAL_PACKAGES" >> $GITHUB_OUTPUT
        echo "CRAWL_TIME=$CRAWL_TIME" >> $GITHUB_OUTPUT
        echo "RECENT_PACKAGE=$RECENT_PACKAGE" >> $GITHUB_OUTPUT

        # Create commit message (å¤šè¡Œå†…å®¹è¦ heredoc)
        cat <<EOF >> $GITHUB_OUTPUT
COMMIT_MESSAGE<<EOM
ğŸ¤– Auto-update: $TOTAL_PACKAGES packages crawled on $(date +'%Y-%m-%d')
ğŸ“Š Statistics:
â€¢ Total packages: $TOTAL_PACKAGES
â€¢ Categories: 22+
â€¢ Most recent: $RECENT_PACKAGE
â€¢ Crawled at: $CRAWL_TIME

ğŸ”„ Generated with Claude Code
Co-Authored-By: Claude <noreply@anthropic.com>
EOM
EOF

    - name: ğŸ” Check for Changes
      id: changes
      run: |
        git add -A
        if git diff --staged --quiet; then
          echo "ğŸ“ No changes detected"
          echo "has_changes=false" >> $GITHUB_OUTPUT
        else
          echo "ğŸ“ Changes detected"
          echo "has_changes=true" >> $GITHUB_OUTPUT

          echo "ğŸ“‹ Changed files:"
          git diff --staged --name-only

          if git diff --staged --name-only | grep -q "packages.json"; then
            echo "ğŸ“Š Package data updated"
          fi

          if git diff --staged --name-only | grep -q "README.md"; then
            echo "ğŸ“„ README updated"
          fi
        fi

    - name: ğŸ’¾ Commit and Push Changes
      if: steps.changes.outputs.has_changes == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"

        # æ³¨æ„å¤šè¡Œ commit message å†™æ³•
        git commit -F- <<EOM
${{ steps.summary.outputs.COMMIT_MESSAGE }}
EOM
        git push
        echo "âœ… Changes committed and pushed successfully"

    - name: ğŸ“Š Create Update Summary Comment
      if: steps.changes.outputs.has_changes == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const summary = `
          ## ğŸš€ OpenHarmony Packages Updated!

          ### ğŸ“Š Summary
          - **Total Packages**: ${process.env.TOTAL_PACKAGES}
          - **Categories**: 22+
          - **Most Recent**: ${process.env.RECENT_PACKAGE}
          - **Status**: âœ… Successfully updated

          ### ğŸ”„ Next Update
          Scheduled for tomorrow at 00:00 UTC (8:00 AM Beijing time)

          ---
          *This update was automatically generated by Git_PACKAGES: ${{ steps.summary.outputs.TOTAL_PACKAGES }}
          RECENT_PACKAGE: ${{ steps.summary.outputs.RECENT_PACKAGE }}